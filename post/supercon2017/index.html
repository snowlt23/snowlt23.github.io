<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Supercon2017参加記</title>
	
	<meta name="description" content="">
	<meta name="image" content="">
	
	<meta itemprop="name" content="Supercon2017参加記">
	<meta itemprop="description" content="">
	<meta itemprop="image" content="">
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="Supercon2017参加記">
	<meta name="twitter:description" content="">
	<meta name="twitter:site" content="@snowlt23">
	<meta name="twitter:creator" content="@snowlt23">
	<meta name="twitter:image:src" content="">
	
	
	<meta name="og:title" content="Supercon2017参加記">
	<meta name="og:description" content="">
	
	<meta name="og:url" content="https://snowlt23.github.io/post/supercon2017/">
	<meta name="og:site_name" content="Supercon2017参加記">
	<meta name="og:type" content="article">
	
	<meta name="article:author" content="snowlt23">
	<meta name="article:tag" content="">
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<script src="/js/caption.js"></script>
</head>

<body>
	



<header >
	<a href="/" style="float: left;color:#777;"><strong>snowlt23&#39;s website</strong></a>
	<a href="https://snowlt23.github.io/about/" style="color:#777;"><strong>About</strong></a>


</header>


<div id="loadingMask" style="width: 100%; height: 100%; position: fixed; background: #fff;"></div>
<script>
function fadeOut(el) {
  el.style.opacity = 1;

  var last = +new Date();
  var tick = function() {
    el.style.opacity = +el.style.opacity - (new Date() - last) / 80;
    last = +new Date();
    

    if (el.style.opacity > 0) {
      (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16);
    } else {
    	el.style.display='none';
    }
  };

  tick();
}

function ready(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
         el = document.getElementById('loadingMask');
         fadeOut(el);
        var elements = document.querySelectorAll("img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("alt")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("alt"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });

    } else {
        document.addEventListener('DOMContentLoaded', fn);
    }
}
window.onload = ready;
</script>

<div class="content">
	<h1>Supercon2017参加記 <aside></aside></h1>
	

<p>この記事は <a href="https://qiita.com/advent-calendar/2017/n-highschool">N高等学校 Advent Calendar 2017</a> 24日目のポエムです。</p>

<p>今更ですが今年の8月頃に開催されたSupercomputing Contest 2017(SuperCon)に参加した記録でも書こうと思います。<br />
本当はFloriという自作言語の記事を書きたかったのですが処理系の実装が目標の段階まで到達できなかったので代わりにこちらを。</p>

<h2 id="superconとは">SuperConとは</h2>

<p><a href="http://www.gsic.titech.ac.jp/supercon/main/attwiki/index.php">http://www.gsic.titech.ac.jp/supercon/main/attwiki/index.php</a></p>

<p>東京工業大学と大阪大学が主催するスーパーコンピューターを使っていい感じに問題を解くコンテストです。５日間(実質4日)かけて解くのでいわゆるマラソン？</p>

<h2 id="事の発端">事の発端</h2>

<p>唐突にSuperCon出ない？とプロたちから誘われる。この時点では競技プログラミング自体は全くの門外漢だったのでどうしようかと戸惑いながらも面白そうなので出てみることにした。ちなみに後でなぜ誘ったのか聞いたらN高等学校学内Slackの#programmingチャンネル見てたら強そうだからという雑な理由だった。</p>

<h2 id="予選">予選</h2>

<p>SuperConの予選はクセ無し種合成問題というものだった。競技プログラミングの門外漢でアルゴリズムに弱い僕はなんか適当な全探索みたいなのを書いて終わった気がする。<br />
なおチームメイトのプロがビームサーチとか使ってめっちゃいい感じのコードを生成してくれたことにより予選を突破できた。:pray:</p>

<h2 id="本戦前">本戦前</h2>

<p>地方勢なので東京まで飛行機で行った。なお東京自体はそこそこ慣れてたので特に問題はなかった。<br />
前日に学校のプログラミング勢+講師で競プロ合宿をした。なお僕は飛行機の関係上途中参加。<br />
本戦の前日の深夜に大阪大学関係で検索したらなんかめっちゃいい感じのSX-ACEの資料が出てきたので慌てて重要そうなところをメモる(SX-ACEはSuperCon2017で使うスパコン)</p>

<h1 id="本戦-ここからがメイン">本戦 (ここからがメイン)</h1>

<h2 id="本戦問題">本戦問題</h2>

<p>本戦の問題は音楽データの圧縮をする問題だった。圧縮といっても色々な圧縮アルゴリズムで片っ端から小さくしろという問題ではなく、PCMデータを音の定数分の上下で表す非可逆圧縮をするという問題。今回求めなくてはならないのはより元の音源を再現できる定数と上下の配列。<br />
で、その圧縮の際に利用するのが大阪大学に導入されているスーパーコンピュータであるSX-ACE。SX-ACEはベクトル型計算機というもので、ざっくりいうと配列に対して同じような処理を複数回適用する際にベクトル化していい感じに高速に計算できる。今回のコンテストはスパコンがメインのコンテストなので、これを有効活用しないといけない。</p>

<h2 id="本戦開始">本戦開始</h2>

<h3 id="1日目">1日目</h3>

<p>とりあえず３人でそれぞれ別な感じの方針でいくことに。この時僕は何を書いたかあまり覚えていない（なんかその時点ではそこそこスコア出てたけどすぐにプロに抜かれて完全に忘却の彼方へいってしまった）</p>

<h3 id="2日目">2日目</h3>

<p>プロが三分探索とかを使ってめっちゃいい感じのスコアを出す。ここからこれを改良していく方針になる。
これを改良していって特にすることがなくなっていた。わりと３人共暇（２人はもとから暇）になってくる。<br />
この時点でプロがDP解を思いついたらしいが実装がやばいらしく一旦保留。</p>

<h3 id="3日目">3日目</h3>

<p>プロが気合でDP解の実装をする。なんかめっちゃやばいスコアが出て３人で笑ってた。しかしこの時点で大きな問題があって、DPでも計算量がめちゃめちゃ重くてすごい小さな音楽データでないと時間内に計算しおわらない。<br />
そこで僕はプロが実装したDP解の高速化に取り掛かった。ようやくまともな仕事をすることになる。
ここでさらに問題発生。プロが実装したDPにバグがあることが発覚。プロは気合でデバッグを開始。</p>

<h3 id="高速化の話-申し訳程度の技術情報">高速化の話 (申し訳程度の技術情報)</h3>

<p>そして僕の高速化はめちゃめちゃ上手く行った。なんかぽんぽんと速度が見違えるように速くなってそこそこ小さめの問題なら解ける程度の速度まで持っていけた。普段はC,Rust,Nimみたいなシステムプログラミング言語とかばかり触っているおかげだろうか。</p>

<p>ちなみにここでした最適化は、主にメモリレイアウトへのアクセスの調整とベクトル化の２つ。</p>

<p>メモリは基本的にCPUに比べると遅いハードなのでメモリからCPUのキャッシュへ上手く載せることが重要になる。で、メモリからキャッシュに載せる際にメモリからは必要なデータだけでなくその周辺のデータもキャッシュへ読み込まれる。なので、連続でアクセスするデータがメモリとして連続しているとメモリアクセスが超高速化されてハッピーということだ。<br />
具体的には、</p>

<pre><code class="language-c">int arr[100][1000];
</code></pre>

<p>という配列が合った時に、</p>

<pre><code class="language-c">for (int j=0; j&lt;1000; j++) {
  for (int i=0; i&lt;100; i++) {
    process(arr[i][j]);
  }
}
</code></pre>

<p>とするよりも、</p>

<pre><code class="language-c">for (int i=0; i&lt;100; i++) {
  for (int j=0; j&lt;1000; j++) {
    process(arr[i][j]);
  }
}
</code></pre>

<p>としたほうが高速になるという具合だ。こうすることにより連続したメモリ領域へのアクセスとなり、メモリアクセスの際に上手くキャッシュに載りかなり高速化される。<br />
ちなみにこれはC言語の例で、Fortranとかではメモリレイアウトが逆になるらしいので注意。</p>

<p>もうひとつの最適化は今回仕様したスパコンのSX-ACE特有の話だが、結構面白い。上記で説明したベクトル化だが、基本的にSX-ACE用のコンパイラが自動でベクトル化をしてくれる。だが、複雑なプログラムになるとコンパイラが依存関係を上手く推論してくれず、本来はベクトル化していいところでベクトル化がされないということがありえる。そこで、この依存関係を強制的に無しとする拡張pragmaが用意されている。これを使うことによって実質的に強制的にベクトル化を指示することができる。(ただし、本来コンパイラが推論できないのに強制でベクトル化させるものなので諸刃の剣である)<br />
今回のスパコンであるSX-ACEのCコンパイラでは<code>#pragma vdir nodep</code>みたいな感じのpragmaだった。</p>

<p>上記の最適化を適用することによって結構速くなった。</p>

<h3 id="4日目">4日目</h3>

<p>4日目は提出に向けての最終調整を行った。というのも、SuperCon自体は５日間だが、最終プログラムの提出が4日目の昼ということになっている。<br />
この４日目はかなり時間が足りなくて、かなりギリギリの中で作業していたと思う。</p>

<p>提出が終わった後はスパコン見学とかがあった。しかし今回自分達は東京会場である東京工業大学での参加だったので、大阪大学のSX-ACEではなく東工大のTSUBAMEを見てきた。めっちゃすごかった（小学生並の語彙力)</p>

<p>なおこのあとは３人でカラオケに行ったりした。楽しかった（小学生並の語彙力)</p>

<h3 id="5日目">5日目</h3>

<p>いよいよ表彰式。最終的にかなり時間が足りなかったので、事故が起こらないことをひたすら祈っていた。<br />
ちなみに結果は祈り虚しく事故って4位。事故らなかったらおそらく2位だった。とてもつらい。</p>

<p>この後は懇親会とかがあった。懇親会で思い切って東工大の先生に話しかけにいって、コンパイラの話をしたりした（僕自身は競プロerではなく言語処理系勢なので）。そこでびっくりしたのが、大阪会場にKyoto Common Lispで有名な荻谷先生がおられるとのこと。これを聞いたときはまじで叫んだ（最高神じゃん）。東京会場だったのでお話できなかったのが悔やまれる。（なお東工大の先生やチューターの方とコンパイラの話をひたすらしてめっちゃ楽しかった(地方勢なのでこういった話をリアルでできるのはめったにない)）</p>

<h1 id="supercon終わり">SuperCon終わり</h1>

<p>とても楽しかった。しかしとても悔いが残る結果となってしまった。<br />
以下ができていればなぁというお気持ち。</p>

<ul>
<li>競プロ力不足 (圧倒的にアルゴリズム力不足だった)</li>
<li>最終的なプログラムより倍高速化 (あと倍高速化していればDP解でも全ての問題が解けたはずで、そうなると最終問題のTLEによる事故も無かったはず)</li>
</ul>

<p>ちなみにこの後パソコン甲子園が開催される予定があり、参加予定だった僕は今回のSuperConで悔しかったのでめっちゃ競プロ猛勉強をした。（なお結果）</p>

<h1 id="総括">総括</h1>

<p>競技プログラミングが強くなりたいと思った。<br />
来年もSuperConがあるはずなのでそれまでに圧倒的精進をしたい。（それに来年のSuperConはおそらく僕の大好きなGPU型スパコンのTSUBAMEのはずなので）<br />
めっちゃいい経験ができたと思う。チームに誘ってくれた２人に圧倒的感謝。:pray:</p>

</div>




	<p><small><em>Written December 24, 2017. </em>
		 
		Send feedback to <a  href="https://twitter.com/intent/tweet?text=%40snowlt23%20%23postsupercon2017%20">@snowlt23</a>.
		
	</small></p>

	<p>
	
	
	</p>









</body>
</html>
